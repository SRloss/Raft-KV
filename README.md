# Raft-KV

为什么做这个项目？

好奇raft怎么保证数据一致性，看了论文文章之后，然后想着怎么去实现就上手了
开发分布式系统的话，想去更深刻理解一下分布式系统的核心算法

技术选择
RPC通信：集群各个节点频繁通信，通常都是在一个局域网内，TCP长连接，选用Solf-bolt

日志和状态机：RocksDB

Leader选举：超时才能选而且不能是leader自己选，各个节点超时时间不能一样，加入随机化否则容易死锁一直选不出来leader，超时后像其他节点并行发送投票请求，有半数同意则当选leader并向其他节点发送心跳信号，如果选举期间收到了心跳信号，立马变为follower。
收到请求投票：收到的话得串行话，需要加锁，因为涉及到状态的修改，如果没拿到锁，不等立即失败ReentrantLock（互斥公平可重入锁）（与synchronized区别：更加灵活，手动锁手动释放，但是容易忘记释放，synchronized会一直获取，reentrantlock可以响应中断）。

日志复制：1 心跳  2 真正日志

心跳：

定时任务，也用定时线程池实现

发送：leader才发

接收：比较自身的term和leader的term

真正日志：

Leader将KV封装成日志并行发送给follower，如果超过1半响应成功，则持久化并返回给客户端成功，将nextIndex到该日志发给其他节点，甚至得发nextIndex之前的
接收：检查term， 如果不匹配告诉leader减小nextIndex，直到完全匹配。

遇到问题，一开始投票忘记加锁，因为涉及到状态的修改，不加锁会引发问题
